@attribute [Authorize]

@page "/MyMessages"
@using HttpClients.ClientInterfaces
@using Domain.Models
@using System.Security.Claims
@using System.Collections
@using Domain.DTOs
@attribute [Authorize]
@inject IMessageService messageService;
@inject IUserService userService;
@inject NavigationManager navMgr;

<h3>Posts</h3>

@if (messages == null)
{
}
else if (!messages.Any())
{
    <p>No Messages to display</p>
}
else
{
    <table class="table">
        <thead>
        <tr>
            <th>Username</th>
            <th>Message</th>
        </tr>

        </thead>
        <tbody>
        @foreach (var item in messages)
        {
            <tr>
                <td>@item.UserFromName</td>
                <td>@item.MessageText</td>
            </tr>
        }
        </tbody>
    </table>
}
@if (!string.IsNullOrEmpty(msg))
{
    <label style="color: red">@msg</label>
}

@code {

    [CascadingParameter]
    public Task<AuthenticationState> AuthState { get; set; } = null!;

    AuthenticationState authState;
    ClaimsPrincipal user;

    private IEnumerable<MessageReadDto>? messages;
    private string msg = "";

    protected override async Task OnInitializedAsync()
    {
        authState = await AuthState;
        user = authState.User;
        await LoadMessages();
    }

    private async Task LoadMessages()
    {
        try
        {
            var id = int.Parse(user.Claims.FirstOrDefault(c => c.Type == "Id")?.Value!);
            var users = await userService.GetUsers();
            messages = await messageService.GetMessagesMadeToUserAsync(id);
            foreach (var messageReadDto in messages)
            {
                messageReadDto.UserFromName = users.FirstOrDefault(u => u.Id == messageReadDto.UserFromId)?.UserName;
            }
        }
        catch (Exception e)
        {
            Console.WriteLine(e);
            msg = e.Message;
        }
    }

}